angular.module('iui.alertModule', ['iui.alertTemplates','iui.alerts']);
var iuiAlertsModule = angular.module('iui.alerts', ['iui.toTrusted']);
/*doc
---
title: iui-alert-placeholder
name: iui-alert-placeholder
category: directives
---
Directive that creates a placeholder area for alerts generated by `iuiAlertService`.

The id is used as the unique identifier for the iuiAlertService.
Always prefix the id with `alert_` like `alert_wizardStep`
This prefix allows us to easily identify alerts in the codebase

Alerts with `type: warning` (red color) should never have a timeout.

```html_example
<iui-alert-placeholder id="alert_exampleArea"></iui-alert-placeholder>
<div ng-controller="AlertController as alertMain">
  <button 
    class="btn btn-default" 
    ng-click="alertMain.iuiAlertService.add('alert_exampleArea', { type: 'info', activeFor: 4000, canClose: true, message: 'Ah, it\'s the old... trick.'})">
    Trigger Example Area Alert (4 second timeout)
  </button>
  <button 
    class="btn btn-default" 
    ng-click="alertMain.iuiAlertService.add('alert_appTop', { type: 'danger', message: 'Pardon me while I get my shoe phone.'})">
    Trigger App Top Alert
  </button>
  <button 
    class="btn btn-default" 
    ng-click="alertMain.iuiAlertService.clear('alert_exampleArea')">
    Hide Example Area Alert
  </button>
  <button 
    class="btn btn-default" 
    ng-click="alertMain.iuiAlertService.clearAll()">
    Hide ALL Alerts
  </button>
</div>
```

```js_example
app.controller('AlertController', ['iuiAlertService', function(iuiAlertService) {
  this.iuiAlertService = iuiAlertService;
}]);
```
*/

/* directive for displaying alerts in a specific area */

iuiAlertsModule.directive('iuiAlertPlaceholder', ['iuiAlertService', 'iuiAlertsConfig', 'iuiAlertLabels', function (iuiAlertService, iuiAlertsConfig, iuiAlertLabels) {
  'use strict';
  return {
    restrict: 'E',
    scope: {},
    templateUrl: '/$iui-alerts/alerts/iui-alert-placeholder.html',

    link: function(scope, element, attrs) {
      var alertId = attrs.id;
      scope.iuiAlertsConfig = iuiAlertsConfig;
      scope.iuiAlertLabels = iuiAlertLabels;
      scope.placementAlerts = iuiAlertService.getCurrent(alertId);

      scope.closeAlert = function() {
        iuiAlertService.closeAlert(alertId);
      };
    }

  };
}]);
iuiAlertsModule.factory('iuiAlertService', ['$timeout', 'iuiAlertsConfig', function (timeout, iuiAlertsConfig) {
  'use strict';
  var defaultTimeOut = iuiAlertsConfig.defaultTimeOut,
    placements = {},
    callback = '',
    DEFAULT_PLACEMENT = iuiAlertsConfig.defaultPlacement;

  return {

    getCurrent: function (id) {
      if (!placements[id]) {
         placements[id] = {};
      }
      return placements[id || DEFAULT_PLACEMENT] || {};
    },

    /* add alert */
    add: function (placement, alertObject) {

      var type = alertObject.type, 
        message = alertObject.message, 
        activeFor = alertObject.activeFor || 0, 
        callback = alertObject.callback,
        canClose = alertObject.canClose;
      
      placement = placement || DEFAULT_PLACEMENT;
      var currentPlacement = placements[placement];
      if(!currentPlacement){
        currentPlacement = placements[placement] = {};
      }

      // if the message is an error, it does not need a timeout
      if (type === 'danger') {
        activeFor = 0;
      }

      currentPlacement.callback = callback;

      var overrides = {
        activeFor: activeFor,
        placement: placement,
        close: function() {
          return asvc.closeAlert();
        }
      };

      currentPlacement.alert = _.extend({}, alertObject, overrides);

      if (currentPlacement.promise) {
        timeout.cancel(currentPlacement.promise);
      }

      if (activeFor === 0) {
        return;
      }

      currentPlacement.promise = timeout(function () {
        currentPlacement.alert = {};
        if (currentPlacement.callback) {
          currentPlacement.callback();
        }
      }, (activeFor !== undefined) ? activeFor : defaultTimeOut);

    },

    /* close alert */
    closeAlert: function (id) {
      var placement = this.getCurrent(id);
      placement.alert = {};
      timeout.cancel(placement.promise);
      if (placement.callback){
        placement.callback();
      }
    },

    clearAll: function () {
      _.each(placements, function(placement) {
        placement.alert = {};
        timeout.cancel(placement.promise);
      });
    },

    /* clear alert */
    clear: function (id) {
      if (id) {
        var current = this.getCurrent(id);
        if(!current){
          return;
        }
        current.alert = {};
        timeout.cancel(current.promise);
      } else {
        this.clearAll();
      }
      
    }

  };

}]);
iuiAlertsModule
  .value('iuiAlertLabels', {
    close: 'Close'
  })
  .constant('iuiAlertsConfig', {
    defaultAlertTemplate: '/$iui-alerts/alerts/iui-default-alert.html',
    defaultTimeOut: 20000,
    defaultPlacement: 'alert_appTop'
  });
/*doc
---
title: to_trusted
name: to_trusted
category: filters
---

Filter to "trust" the HTML source. This is useful for binding HTML from the API. 
Please use caution when using this filter. If you find yourself storing bits and 
pieces of HTML in a service or controller, consider using an `ng-include` or a `directive` instead.

```html_example
<div ng-controller="ToTrustedController as example">
  <span ng-bind-html="example.quote | to_trusted"></span>
</div>
```

```js_example
app.controller('ToTrustedController', [function() {
  // This is strictly an example. Please do not store HTML in Javascript files
  this.quote = '<blockquote><em>Good thinking, Max.</em> &mdash; <strong>Agent 99</strong></blockquote>';
}]);
```
*/


// This filter allows you to use ng-bind-html when html is coming from the API
angular.module('iui.toTrusted', []).filter('to_trusted', ['$sce', function($sce){
  'use strict';
  return function(text) {
    return $sce.trustAsHtml(text);
  };
}]);
(function(module) {
try {
  module = angular.module('iui.alertTemplates');
} catch (e) {
  module = angular.module('iui.alertTemplates', []);
}
module.run(['$templateCache', function($templateCache) {
  $templateCache.put('/$iui-alerts/alerts/iui-alert-placeholder.html',
    '<div \n' +
    '  ng-if="placementAlerts.alert.message" \n' +
    '  class="alert-wrapper"\n' +
    '  ng-include="placementAlerts.alert.templateUrl || iuiAlertsConfig.defaultAlertTemplate">\n' +
    '</div>');
}]);
})();

(function(module) {
try {
  module = angular.module('iui.alertTemplates');
} catch (e) {
  module = angular.module('iui.alertTemplates', []);
}
module.run(['$templateCache', function($templateCache) {
  $templateCache.put('/$iui-alerts/alerts/iui-default-alert.html',
    '<div \n' +
    '  class="alert alert-{{placementAlerts.alert.type}}" \n' +
    '  role="alert">\n' +
    '  <span \n' +
    '    class="alert-message" \n' +
    '    ng-bind-html="placementAlerts.alert.message | to_trusted">\n' +
    '  </span>\n' +
    '  <button \n' +
    '    ng-if="placementAlerts.alert.canClose"\n' +
    '    type="button" \n' +
    '    class="close" \n' +
    '    aria-label="{{iuiAlertLabels.close}}" \n' +
    '    ng-click="closeAlert()">\n' +
    '    <span aria-hidden="true">&times;</span>\n' +
    '  </button>\n' +
    '</div>');
}]);
})();
